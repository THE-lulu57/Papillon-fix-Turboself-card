name: Build IPA pour Sideload

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Installation de Yarn
      run: npm install -g yarn
      
    - name: Installation des dépendances
      run: yarn install --ignore-scripts || true
      
    - name: Suppression des patches problématiques
      run: |
        rm -f patches/@react-native-menu+menu+1.2.4.patch
        rm -f patches/react-native-mmkv+3.3.0.patch
        
    - name: Réinstallation avec patches corrigés
      run: yarn install
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        
    - name: Installation de CocoaPods
      run: |
        cd ios
        # Ajouter use_modular_headers! au Podfile
        if ! grep -q "use_modular_headers!" Podfile; then
          sed -i '' '1s/^/use_modular_headers!\n\n/' Podfile
        fi
        pod install
        cd ..
        
    - name: Build IPA (sans signature)
      run: |
        cd ios
        xcodebuild -workspace Papillon.xcworkspace \
          -scheme Papillon \
          -configuration Release \
          -sdk iphoneos \
          -archivePath $PWD/build/Papillon.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          archive
          
    - name: Export IPA
      run: |
        cd ios
        mkdir -p Payload
        cp -r build/Papillon.xcarchive/Products/Applications/Papillon.app Payload/
        zip -r Papillon-unsigned.ipa Payload
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Papillon-unsigned-ipa
        path: ios/Papillon-unsigned.ipa
        retention-days: 30
        
    - name: Créer Release (optionnel)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        files: ios/Papillon-unsigned.ipa
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
