name: Build IPA pour Sideload

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Type de build'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - eas

jobs:
  build-local:
    if: github.event.inputs.build_type == 'local' || github.event.inputs.build_type == ''
    runs-on: macos-14
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Installation de Yarn
      run: npm install -g yarn
      
    - name: Installation des dÃ©pendances
      run: yarn install --ignore-scripts || true
      
    - name: Suppression des patches problÃ©matiques
      run: |
        rm -f patches/@react-native-menu+menu+1.2.4.patch
        rm -f patches/react-native-mmkv+3.3.0.patch
        
    - name: RÃ©installation avec patches corrigÃ©s
      run: yarn install
      
    - name: Installation d'EAS CLI
      run: npm install -g eas-cli
      
    - name: CrÃ©er eas.json
      run: |
        cat > eas.json << 'EOF'
        {
          "cli": {
            "version": ">= 13.2.0"
          },
          "build": {
            "unsigned": {
              "distribution": "internal",
              "ios": {
                "simulator": false,
                "buildConfiguration": "Release",
                "enterpriseProvisioning": "adhoc"
              }
            }
          }
        }
        EOF
        
    - name: Build IPA local (sans signature)
      run: |
        eas build --platform ios --profile unsigned --local --non-interactive --output ./Papillon-unsigned.ipa || {
          echo "âš ï¸ Build EAS Ã©chouÃ©, tentative avec prebuild + xcodebuild..."
          
          # Fallback vers build manuel
          npx expo prebuild --platform ios --clean
          
          cd ios
          pod install
          
          xcodebuild archive \
            -workspace Papillon.xcworkspace \
            -scheme Papillon \
            -configuration Release \
            -sdk iphoneos \
            -archivePath $PWD/build/Papillon.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            ENABLE_BITCODE=NO
            
          mkdir -p Payload
          cp -r build/Papillon.xcarchive/Products/Applications/Papillon.app Payload/
          zip -r ../Papillon-unsigned.ipa Payload
          cd ..
        }
        
    - name: VÃ©rifier l'IPA
      run: |
        if [ -f "Papillon-unsigned.ipa" ]; then
          echo "âœ… IPA crÃ©Ã©e avec succÃ¨s"
          ls -lh Papillon-unsigned.ipa
        else
          echo "âŒ IPA non trouvÃ©e"
          exit 1
        fi
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Papillon-unsigned-ipa
        path: Papillon-unsigned.ipa
        retention-days: 30
        
    - name: CrÃ©er Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        body: |
          ðŸš€ Build automatique IPA non signÃ©e
          
          ðŸ“± Pour installer :
          1. TÃ©lÃ©chargez l'IPA ci-dessous
          2. Utilisez AltStore, Sideloadly, ou un autre outil de sideload
          3. Signez avec votre Apple ID gratuit
          
          âš ï¸ NÃ©cessite un outil de sideload car l'IPA n'est pas signÃ©e
        files: Papillon-unsigned.ipa
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-eas:
    if: github.event.inputs.build_type == 'eas'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup Expo and EAS
      uses: expo/expo-github-action@v8
      with:
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}
        
    - name: Installation des dÃ©pendances
      run: yarn install
      
    - name: CrÃ©er eas.json
      run: |
        cat > eas.json << 'EOF'
        {
          "cli": {
            "version": ">= 13.2.0"
          },
          "build": {
            "unsigned": {
              "distribution": "internal",
              "ios": {
                "simulator": false,
                "buildConfiguration": "Release"
              }
            }
          }
        }
        EOF
        
    - name: Build IPA avec EAS
      run: eas build --platform ios --profile unsigned --non-interactive
        
    - name: RÃ©cupÃ©rer l'IPA
      run: |
        echo "âœ… Build terminÃ© sur les serveurs EAS"
        echo "ðŸ“± TÃ©lÃ©chargez l'IPA depuis : https://expo.dev"
